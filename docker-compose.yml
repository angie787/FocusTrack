services:
  # --- Identity Provider (OIDC) ---
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: focustrack-keycloak
    user: root
    command: start-dev
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      # Networking Configuration
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
    healthcheck:
      test: ["CMD-SHELL", "timeout 1s bash -c ':> /dev/tcp/127.0.0.1/8080' || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 10
    volumes:
      - keycloak_data:/opt/keycloak/data/h2
    ports:
      - "9080:8080"
    networks:
      - focustrack

  # --- Infrastructure ---
  postgres-sessions:
    image: postgres:16-alpine
    container_name: focustrack-postgres-sessions
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: sessions
    ports:
      - "5432:5432"
    volumes:
      - postgres_sessions_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d sessions"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - focustrack

  postgres-rewards:
    image: postgres:16-alpine
    container_name: focustrack-postgres-rewards
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rewards
    ports:
      - "5433:5432"
    volumes:
      - postgres_rewards_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U focustrack -d rewards"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - focustrack

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: focustrack-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - focustrack
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  jaeger:
    image: jaegertracing/all-in-one:1.57
    container_name: focustrack-jaeger
    ports:
      - "16686:16686"
      - "4317:4317"
    networks:
      - focustrack

  # --- .NET Microservices ---
  gateway:
    build:
      context: .
      dockerfile: Gateway/FocusTrack.Gateway.Api/Dockerfile
    container_name: focustrack-gateway
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      Oidc__ClientId: "focus-track-client"
      Oidc__ClientSecret: "ooQJPaasjzeqKwa5fQGVPGD9ui7Kdg2a"
      SessionApi__BaseAddress: "http://session-service:8080/"
      SessionApi__InternalApiKey: "focustrack-internal-key"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    ports:
      - "5000:8080"
    depends_on:
      keycloak:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - focustrack

  session-api:
    build:
      context: .
      dockerfile: Session/FocusTrack.Session.Api/Dockerfile
    container_name: focustrack-session-api
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Sessions: "Host=postgres-sessions;Port=5432;Database=sessions;Username=postgres;Password=postgres"
      InternalApi__ApiKey: "focustrack-internal-key"
      RabbitMQ__HostName: rabbitmq
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    ports:
      - "5001:8080"
    depends_on:
      postgres-sessions:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      focustrack:
        aliases:
          - session-service

  reward-worker:
    build:
      context: .
      dockerfile: RewardWorker/FocusTrack.RewardWorker/Dockerfile
    container_name: focustrack-reward-worker
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Rewards: "Host=postgres-rewards;Port=5432;Database=rewards;Username=focustrack;Password=focustrack_secret"
      RabbitMQ__HostName: rabbitmq
      SessionApi__BaseAddress: "http://session-service:8080/"
      SessionApi__InternalApiKey: "focustrack-internal-key"
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-rewards:
        condition: service_healthy
      session-api:
        condition: service_started
    networks:
      - focustrack

  notification-api:
    build:
      context: .
      dockerfile: Notification/FocusTrack.Notification.Api/Dockerfile
    container_name: focustrack-notification-api
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      RabbitMQ__HostName: rabbitmq
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    ports:
      - "5002:8080"
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      focustrack:
        aliases:
          - notification-service

networks:
  focustrack:
    driver: bridge

volumes:
  keycloak_data:
  rabbitmq_data:
  postgres_sessions_data:
  postgres_rewards_data:
